-- Wellness & Mental Health Tracking System
-- Sprint 37: Mental Health Integration
--
-- PHQ-2/GAD-2 validated screening with safety guardrails.
-- Exercise intervention tracking and crisis resource logging.
--
-- ⚠️ LEGAL DISCLAIMER:
-- This schema supports screening tools for INFORMATIONAL PURPOSES ONLY.
-- NOT a diagnostic tool. Legal review REQUIRED before production deployment.

-- =====================================================================
-- WELLNESS SCREENINGS
-- =====================================================================

-- Wellness screening results (PHQ-2, GAD-2)
CREATE TABLE wellness_screenings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,

    -- Screening details
    screening_type TEXT NOT NULL CHECK (screening_type IN ('phq2', 'gad2', 'combined')),
    score INT NOT NULL CHECK (score >= 0 AND score <= 6),
    severity TEXT NOT NULL CHECK (severity IN ('minimal', 'mild', 'moderate', 'severe')),

    -- Flags
    needs_followup BOOLEAN NOT NULL DEFAULT FALSE,
    needs_professional_referral BOOLEAN NOT NULL DEFAULT FALSE,
    crisis_concern BOOLEAN NOT NULL DEFAULT FALSE,

    -- Responses (stored as JSONB for flexibility)
    responses JSONB NOT NULL, -- {"phq2_q1": 2, "phq2_q2": 1, ...}

    -- Recommendations generated
    recommendations JSONB, -- Array of recommendation strings
    exercise_interventions JSONB, -- Array of exercise intervention strings
    professional_resources JSONB, -- Array of resource strings

    -- Metadata
    screened_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    notes JSONB, -- Array of note strings

    -- Tracking
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_wellness_screenings_user_id ON wellness_screenings(user_id);
CREATE INDEX idx_wellness_screenings_screened_at ON wellness_screenings(screened_at DESC);
CREATE INDEX idx_wellness_screenings_severity ON wellness_screenings(severity);
CREATE INDEX idx_wellness_screenings_crisis ON wellness_screenings(crisis_concern) WHERE crisis_concern = TRUE;

-- Updated at trigger
CREATE TRIGGER update_wellness_screenings_updated_at
    BEFORE UPDATE ON wellness_screenings
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- RLS Policies
ALTER TABLE wellness_screenings ENABLE ROW LEVEL SECURITY;

-- Users can view their own screenings
CREATE POLICY "Users can view own wellness screenings"
    ON wellness_screenings FOR SELECT
    USING (auth.uid() = user_id);

-- Users can insert their own screenings
CREATE POLICY "Users can insert own wellness screenings"
    ON wellness_screenings FOR INSERT
    WITH CHECK (auth.uid() = user_id);

-- Users can update their own screenings
CREATE POLICY "Users can update own wellness screenings"
    ON wellness_screenings FOR UPDATE
    USING (auth.uid() = user_id);

-- Trainers can view their clients' screenings (via trainer_clients relationship)
CREATE POLICY "Trainers can view client wellness screenings"
    ON wellness_screenings FOR SELECT
    USING (
        EXISTS (
            SELECT 1 FROM client_profiles
            WHERE client_profiles.id = wellness_screenings.user_id
            AND client_profiles.trainer_id = auth.uid()
            AND trainer_clients.status = 'active'
        )
    );

-- =====================================================================
-- WORKOUT INTERVENTIONS
-- =====================================================================

-- Mood-boosting workout recommendations and tracking
CREATE TABLE wellness_workout_plans (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    screening_id UUID REFERENCES wellness_screenings(id) ON DELETE SET NULL,

    -- Recommendation details
    workout_type TEXT NOT NULL CHECK (workout_type IN ('dance', 'walking', 'jogging', 'yoga', 'strength', 'group_fitness', 'hiit', 'cycling', 'swimming')),
    intensity TEXT NOT NULL CHECK (intensity IN ('low', 'moderate', 'high')),
    duration_minutes INT NOT NULL CHECK (duration_minutes > 0),
    frequency_per_week INT NOT NULL CHECK (frequency_per_week >= 1 AND frequency_per_week <= 7),

    -- Research backing
    effect_size TEXT, -- "Large (g=-0.96)", "Medium (g=-0.43)", etc.
    research_notes TEXT,

    -- Practical guidance (stored as JSONB)
    how_to_start JSONB, -- Array of strings
    progression JSONB, -- Array of strings
    barriers_solutions JSONB, -- Object mapping barrier to solution

    -- Status
    status TEXT NOT NULL DEFAULT 'recommended' CHECK (status IN ('recommended', 'active', 'completed', 'discontinued')),
    started_at TIMESTAMPTZ,
    completed_at TIMESTAMPTZ,

    -- Metadata
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_wellness_workout_plans_user_id ON wellness_workout_plans(user_id);
CREATE INDEX idx_wellness_workout_plans_screening_id ON wellness_workout_plans(screening_id);
CREATE INDEX idx_wellness_workout_plans_status ON wellness_workout_plans(status);

-- Updated at trigger
CREATE TRIGGER update_wellness_workout_plans_updated_at
    BEFORE UPDATE ON wellness_workout_plans
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- RLS Policies
ALTER TABLE wellness_workout_plans ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can manage own wellness workout plans"
    ON wellness_workout_plans FOR ALL
    USING (auth.uid() = user_id);

CREATE POLICY "Trainers can view client wellness workout plans"
    ON wellness_workout_plans FOR SELECT
    USING (
        EXISTS (
            SELECT 1 FROM client_profiles
            WHERE client_profiles.id = wellness_workout_plans.user_id
            AND client_profiles.trainer_id = auth.uid()
            AND trainer_clients.status = 'active'
        )
    );

-- =====================================================================
-- WORKOUT SESSIONS (Mood tracking)
-- =====================================================================

-- Individual workout session logs with mood tracking
CREATE TABLE wellness_workout_sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    plan_id UUID REFERENCES wellness_workout_plans(id) ON DELETE SET NULL,

    -- Session details
    workout_type TEXT NOT NULL,
    duration_minutes INT NOT NULL CHECK (duration_minutes > 0),
    intensity TEXT NOT NULL CHECK (intensity IN ('low', 'moderate', 'high')),

    -- Mood tracking (before/after)
    mood_before INT CHECK (mood_before >= 1 AND mood_before <= 10), -- 1=terrible, 10=excellent
    mood_after INT CHECK (mood_after >= 1 AND mood_after <= 10),
    energy_before INT CHECK (energy_before >= 1 AND energy_before <= 10),
    energy_after INT CHECK (energy_after >= 1 AND energy_after <= 10),

    -- Session notes
    notes TEXT,
    completed BOOLEAN NOT NULL DEFAULT TRUE,

    -- Metadata
    session_date DATE NOT NULL DEFAULT CURRENT_DATE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_wellness_workout_sessions_user_id ON wellness_workout_sessions(user_id);
CREATE INDEX idx_wellness_workout_sessions_plan_id ON wellness_workout_sessions(plan_id);
CREATE INDEX idx_wellness_workout_sessions_date ON wellness_workout_sessions(session_date DESC);

-- Updated at trigger
CREATE TRIGGER update_wellness_workout_sessions_updated_at
    BEFORE UPDATE ON wellness_workout_sessions
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- RLS Policies
ALTER TABLE wellness_workout_sessions ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can manage own wellness workout sessions"
    ON wellness_workout_sessions FOR ALL
    USING (auth.uid() = user_id);

CREATE POLICY "Trainers can view client wellness workout sessions"
    ON wellness_workout_sessions FOR SELECT
    USING (
        EXISTS (
            SELECT 1 FROM client_profiles
            WHERE client_profiles.id = wellness_workout_sessions.user_id
            AND client_profiles.trainer_id = auth.uid()
            AND trainer_clients.status = 'active'
        )
    );

-- =====================================================================
-- CRISIS RESOURCE ACCESS LOG
-- =====================================================================

-- Log when users access crisis resources (for safety monitoring)
CREATE TABLE wellness_crisis_resource_access (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    screening_id UUID REFERENCES wellness_screenings(id) ON DELETE SET NULL,

    -- Resource accessed
    resource_type TEXT NOT NULL CHECK (resource_type IN ('crisis_hotline', 'crisis_text', 'emergency', 'therapist_finder', 'support_group', 'telehealth', 'specialized')),
    resource_name TEXT NOT NULL, -- "988 Suicide & Crisis Lifeline", "Crisis Text Line", etc.
    urgency_level TEXT NOT NULL CHECK (urgency_level IN ('immediate', 'urgent', 'important', 'routine')),

    -- Context
    triggered_by_screening BOOLEAN NOT NULL DEFAULT FALSE,

    -- Metadata
    accessed_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_wellness_crisis_access_user_id ON wellness_crisis_resource_access(user_id);
CREATE INDEX idx_wellness_crisis_access_screening_id ON wellness_crisis_resource_access(screening_id);
CREATE INDEX idx_wellness_crisis_access_urgency ON wellness_crisis_resource_access(urgency_level);
CREATE INDEX idx_wellness_crisis_access_date ON wellness_crisis_resource_access(accessed_at DESC);

-- RLS Policies
ALTER TABLE wellness_crisis_resource_access ENABLE ROW LEVEL SECURITY;

-- Users can view their own access logs
CREATE POLICY "Users can view own crisis resource access"
    ON wellness_crisis_resource_access FOR SELECT
    USING (auth.uid() = user_id);

-- Users can insert their own access logs
CREATE POLICY "Users can insert own crisis resource access"
    ON wellness_crisis_resource_access FOR INSERT
    WITH CHECK (auth.uid() = user_id);

-- Trainers can view their clients' access logs (for safety monitoring)
CREATE POLICY "Trainers can view client crisis resource access"
    ON wellness_crisis_resource_access FOR SELECT
    USING (
        EXISTS (
            SELECT 1 FROM client_profiles
            WHERE client_profiles.id = wellness_crisis_resource_access.user_id
            AND client_profiles.trainer_id = auth.uid()
            AND trainer_clients.status = 'active'
        )
    );

-- =====================================================================
-- WELLNESS PROGRESS TRACKING
-- =====================================================================

-- Aggregate wellness metrics for trend analysis
CREATE TABLE wellness_progress (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,

    -- Period
    week_start DATE NOT NULL, -- Start of week (Monday)
    week_end DATE NOT NULL, -- End of week (Sunday)

    -- Screening trends
    avg_phq2_score DECIMAL(3,1), -- Average PHQ-2 score this week
    avg_gad2_score DECIMAL(3,1), -- Average GAD-2 score this week
    screening_count INT NOT NULL DEFAULT 0,

    -- Workout adherence
    planned_workouts INT NOT NULL DEFAULT 0,
    completed_workouts INT NOT NULL DEFAULT 0,
    adherence_rate DECIMAL(3,2), -- completed / planned

    -- Mood trends
    avg_mood_improvement DECIMAL(3,2), -- Average (mood_after - mood_before)
    avg_energy_improvement DECIMAL(3,2), -- Average (energy_after - energy_before)

    -- Metadata
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

    UNIQUE(user_id, week_start)
);

-- Indexes
CREATE INDEX idx_wellness_progress_user_id ON wellness_progress(user_id);
CREATE INDEX idx_wellness_progress_week ON wellness_progress(week_start DESC);

-- Updated at trigger
CREATE TRIGGER update_wellness_progress_updated_at
    BEFORE UPDATE ON wellness_progress
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- RLS Policies
ALTER TABLE wellness_progress ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own wellness progress"
    ON wellness_progress FOR SELECT
    USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own wellness progress"
    ON wellness_progress FOR INSERT
    WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own wellness progress"
    ON wellness_progress FOR UPDATE
    USING (auth.uid() = user_id);

CREATE POLICY "Trainers can view client wellness progress"
    ON wellness_progress FOR SELECT
    USING (
        EXISTS (
            SELECT 1 FROM client_profiles
            WHERE client_profiles.id = wellness_progress.user_id
            AND client_profiles.trainer_id = auth.uid()
            AND trainer_clients.status = 'active'
        )
    );

-- =====================================================================
-- HELPER FUNCTIONS
-- =====================================================================

-- Function to calculate weekly wellness progress
CREATE OR REPLACE FUNCTION calculate_wellness_progress(
    p_user_id UUID,
    p_week_start DATE
)
RETURNS void
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_week_end DATE;
    v_screening_count INT;
    v_avg_phq2 DECIMAL(3,1);
    v_avg_gad2 DECIMAL(3,1);
    v_planned INT;
    v_completed INT;
    v_adherence DECIMAL(3,2);
    v_mood_improvement DECIMAL(3,2);
    v_energy_improvement DECIMAL(3,2);
BEGIN
    -- Calculate week end (Sunday)
    v_week_end := p_week_start + INTERVAL '6 days';

    -- Screening metrics
    SELECT
        COUNT(*),
        AVG(CASE WHEN screening_type IN ('phq2', 'combined') THEN score ELSE NULL END),
        AVG(CASE WHEN screening_type IN ('gad2', 'combined') THEN score ELSE NULL END)
    INTO v_screening_count, v_avg_phq2, v_avg_gad2
    FROM wellness_screenings
    WHERE user_id = p_user_id
    AND screened_at::DATE BETWEEN p_week_start AND v_week_end;

    -- Workout metrics
    SELECT
        COUNT(*) FILTER (WHERE status = 'active'),
        COUNT(*) FILTER (WHERE completed = TRUE)
    INTO v_planned, v_completed
    FROM wellness_workout_sessions
    WHERE user_id = p_user_id
    AND session_date BETWEEN p_week_start AND v_week_end;

    -- Calculate adherence
    IF v_planned > 0 THEN
        v_adherence := v_completed::DECIMAL / v_planned::DECIMAL;
    ELSE
        v_adherence := NULL;
    END IF;

    -- Mood improvements
    SELECT
        AVG(mood_after - mood_before),
        AVG(energy_after - energy_before)
    INTO v_mood_improvement, v_energy_improvement
    FROM wellness_workout_sessions
    WHERE user_id = p_user_id
    AND session_date BETWEEN p_week_start AND v_week_end
    AND mood_before IS NOT NULL
    AND mood_after IS NOT NULL
    AND energy_before IS NOT NULL
    AND energy_after IS NOT NULL;

    -- Upsert progress record
    INSERT INTO wellness_progress (
        user_id,
        week_start,
        week_end,
        avg_phq2_score,
        avg_gad2_score,
        screening_count,
        planned_workouts,
        completed_workouts,
        adherence_rate,
        avg_mood_improvement,
        avg_energy_improvement
    ) VALUES (
        p_user_id,
        p_week_start,
        v_week_end,
        v_avg_phq2,
        v_avg_gad2,
        v_screening_count,
        v_planned,
        v_completed,
        v_adherence,
        v_mood_improvement,
        v_energy_improvement
    )
    ON CONFLICT (user_id, week_start)
    DO UPDATE SET
        week_end = EXCLUDED.week_end,
        avg_phq2_score = EXCLUDED.avg_phq2_score,
        avg_gad2_score = EXCLUDED.avg_gad2_score,
        screening_count = EXCLUDED.screening_count,
        planned_workouts = EXCLUDED.planned_workouts,
        completed_workouts = EXCLUDED.completed_workouts,
        adherence_rate = EXCLUDED.adherence_rate,
        avg_mood_improvement = EXCLUDED.avg_mood_improvement,
        avg_energy_improvement = EXCLUDED.avg_energy_improvement,
        updated_at = NOW();
END;
$$;

-- =====================================================================
-- COMMENTS
-- =====================================================================

COMMENT ON TABLE wellness_screenings IS 'PHQ-2/GAD-2 validated mental health screening results. FOR INFORMATIONAL PURPOSES ONLY.';
COMMENT ON TABLE wellness_workout_plans IS 'Mood-boosting workout recommendations based on BMJ 2024 research.';
COMMENT ON TABLE wellness_workout_sessions IS 'Individual workout sessions with before/after mood tracking.';
COMMENT ON TABLE wellness_crisis_resource_access IS 'Log of crisis resource access for safety monitoring.';
COMMENT ON TABLE wellness_progress IS 'Weekly aggregate wellness metrics for trend analysis.';
COMMENT ON FUNCTION calculate_wellness_progress IS 'Calculate weekly wellness progress metrics for a user.';
