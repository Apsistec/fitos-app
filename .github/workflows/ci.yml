# CI Pipeline - Validates all PRs and pushes to main
# Runs: lint, test (with coverage), production builds, Lighthouse audits
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    name: Lint, Test & Build
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for Nx affected

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: 'npm'

      # Nx affected needs base/head SHAs for comparison
      - name: Derive Nx SHAs
        uses: nrwl/nx-set-shas@v4

      - name: Install dependencies
        run: npm ci

      # Lint affected projects (fast - parallel)
      - name: Lint
        run: npx nx affected -t lint --parallel=3

      # Test affected projects with coverage (CI mode)
      - name: Test
        run: npx nx affected -t test --parallel=3 --configuration=ci

      # Always build both apps in production mode to catch build errors
      - name: Build Mobile App
        run: npx nx build fitos-mobile --configuration=production

      - name: Build Landing Page
        run: |
          node scripts/generate-changelog.js
          npx nx build fitos-landing --configuration=production

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Lighthouse CI - Performance regression detection
  # Runs after builds succeed, audits both apps against budgets
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lighthouse:
    name: Lighthouse Audit
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Mobile App
        run: npx nx build fitos-mobile --configuration=production

      - name: Build Landing Page
        run: |
          node scripts/generate-changelog.js
          npx nx build fitos-landing --configuration=production

      # Lighthouse CI for Mobile PWA
      - name: Lighthouse - Mobile App
        uses: treosh/lighthouse-ci-action@v12
        with:
          configPath: ./lighthouserc.json
          uploadArtifacts: true
          temporaryPublicStorage: true

      # Post results as PR comment
      - name: Format Lighthouse Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const resultsPath = '.lighthouseci';
            if (!fs.existsSync(resultsPath)) return;

            const files = fs.readdirSync(resultsPath).filter(f => f.endsWith('.json') && f.startsWith('lhr-'));
            if (files.length === 0) return;

            let comment = '## âš¡ Lighthouse Report\n\n';
            for (const file of files) {
              const lhr = JSON.parse(fs.readFileSync(`${resultsPath}/${file}`, 'utf8'));
              const url = lhr.finalUrl || lhr.requestedUrl || 'Unknown';
              const perf = Math.round((lhr.categories?.performance?.score || 0) * 100);
              const a11y = Math.round((lhr.categories?.accessibility?.score || 0) * 100);
              const bp = Math.round((lhr.categories?.['best-practices']?.score || 0) * 100);
              const seo = Math.round((lhr.categories?.seo?.score || 0) * 100);

              const emoji = (s) => s >= 90 ? 'ðŸŸ¢' : s >= 50 ? 'ðŸŸ ' : 'ðŸ”´';
              comment += `### ${url}\n`;
              comment += `| Category | Score |\n|----------|-------|\n`;
              comment += `| ${emoji(perf)} Performance | **${perf}** |\n`;
              comment += `| ${emoji(a11y)} Accessibility | **${a11y}** |\n`;
              comment += `| ${emoji(bp)} Best Practices | **${bp}** |\n`;
              comment += `| ${emoji(seo)} SEO | **${seo}** |\n\n`;
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment,
            });
